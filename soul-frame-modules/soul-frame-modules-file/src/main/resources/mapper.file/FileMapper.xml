<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.clm.modules.file.mapper.FileMapper">
    <sql id="selectSql">
        SELECT
        a.file_id, a.file_name, a.file_extension, a.original_name, a.file_size, a.file_hash, a.mime_type, a.encoding,
        a.storage_path, a.storage_type, a.bucket_name, a.owner_id, a.status, a.is_public, a.is_encrypted,
        a.width, a.height, a.duration, a.version_number, a.is_latest_version, a.upload_ip, a.upload_user_agent,
        a.upload_source, a.download_count, a.view_count, a.last_accessed_at, a.metadata, a.tags, a.description,
        a.create_time,
        a.file_url,
        b.user_name
        FROM sys_file a
        left join sys_user b on a.owner_id = b.user_id
        <where>
            a.del_flag = '0'
            <if test="param.fileName != null and param.fileName != ''">
                AND a.file_name LIKE CONCAT('%', #{param.fileName}, '%')
            </if>
            <if test="param.originalName != null and param.originalName != ''">
                AND a.original_name LIKE CONCAT('%', #{param.originalName}, '%')
            </if>
            <if test="param.fileExtension != null and param.fileExtension != ''">
                AND a.file_extension = #{param.fileExtension}
            </if>
            <if test="param.fileExtensionList!=null and param.fileExtensionList.size>0">
                AND a.file_extension IN
                <foreach item="item" collection="param.fileExtensionList" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
            <if test="param.storageType != null and param.storageType != ''">
                AND a.storage_type = #{param.storageType}
            </if>
            <if test="param.status != null and param.status != ''">
                AND a.status = #{param.status}
            </if>
            <if test="param.isPublic != null">
                AND a.is_public = #{param.isPublic}
            </if>
            <if test="param.ownerId != null">
                AND a.owner_id = #{param.ownerId}
            </if>
            <if test="param.beginTime != null">
                AND a.create_time &gt;= #{param.beginTime}
            </if>
            <if test="param.endTime != null">
                AND a.create_time &lt;= #{param.endTime}
            </if>
        </where>
        ORDER BY create_time DESC
    </sql>

    <select id="selectFilePage" resultType="com.clm.system.domain.vo.FileVO">
        <include refid="selectSql"/>
    </select>
    <select id="selectFileList" resultType="com.clm.system.domain.vo.FileVO">
        <include refid="selectSql"/>
    </select>

    <update id="updateAccessCount">
        UPDATE sys_file
        <if test="type == 'view'">
            SET view_count = view_count + 1, last_accessed_at = NOW()
        </if>
        <if test="type == 'download'">
            SET download_count = download_count + 1, last_accessed_at = NOW()
        </if>
        WHERE file_id = #{fileId}
    </update>
</mapper> 